<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Platforma Załadunku i Rozładunku</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabase = supabase.createClient(
      'https://bfknyzfmhojjghhkxyrv.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJma255emZtaG9qamdoaGt4eXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyOTc4NTYsImV4cCI6MjA2Mzg3Mzg1Nn0.pQbR3wHdzhE4nP7PEIn5rASLNNwFa3-qKqkymDgxVLc'
    );

    async function autoSave(row) {
      if (!row || !row.cells || row.cells.length < 13) return;
      const input = (i) => row.cells[i]?.querySelector("input, select, textarea")?.value?.trim() || "";

      const dane = {
        zaladunek: input(1),
        data_zaladunku_od: row.cells[2].querySelectorAll("input")[0]?.value.trim() || "",
        data_zaladunku_do: row.cells[2].querySelectorAll("input")[1]?.value.trim() || "",
        godzina_zaladunku_od: row.cells[3].querySelectorAll("input")[0]?.value.trim() || "",
        godzina_zaladunku_do: row.cells[3].querySelectorAll("input")[1]?.value.trim() || "",
        rozladunek: input(4),
        data_rozladunku_od: row.cells[5].querySelectorAll("input")[0]?.value.trim() || "",
        data_rozladunku_do: row.cells[5].querySelectorAll("input")[1]?.value.trim() || "",
        godzina_rozladunku_od: row.cells[6].querySelectorAll("input")[0]?.value.trim() || "",
        godzina_rozladunku_do: row.cells[6].querySelectorAll("input")[1]?.value.trim() || "",
        sposob_zaladunku: input(7),
        aktualnosc: input(8),
        uwagi: input(9),
        stawka: input(10),
        kilometry: input(11),
        stawka_km: input(12)
      };

      const filled = Object.values(dane).filter(v => v !== "").length;
      if (filled < 2) {
        console.log("\u26d4 Pominięto zapis - mniej niż 2 pola");
        return;
      }

      if (row.dataset.id) {
        const { error } = await supabase.from("translider").update(dane).eq("id", row.dataset.id);
        if (error) {
          console.error("\u274c Błąd aktualizacji:", error.message);
        } else {
          console.log("\u267b Zaktualizowano wiersz:", row.dataset.id);
        }
      } else {
        const { data, error } = await supabase.from("translider").insert([dane]).select("id");
        if (error) {
          console.error("\u274c Błąd zapisu:", error.message);
        } else {
          console.log("\u2705 Zapisano wiersz:", data[0]?.id);
          row.dataset.zapisany = "true";
          row.dataset.id = data[0]?.id;
        }
      }
    }

    document.addEventListener("change", (e) => {
      const row = e.target.closest("tr");
      if (row) autoSave(row);
    });

    document.addEventListener("blur", (e) => {
      const row = e.target.closest("tr");
      if (row) autoSave(row);
    }, true);
  </script>
  <style>
    body { font-family: Arial, sans-serif; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    .pilne { background-color: #ffe6e6; }
    .status-aktualne { background-color: #a5f3a1 !important; font-weight: bold; }
    .status-nieaktualne { background-color: #f9a1a1 !important; font-weight: bold; }
    .status-nieznane { background-color: #fff7a1 !important; font-weight: bold; }
    .date-time-group input { width: 45%; display: inline-block; margin: 2px 1%; }
    textarea { width: 100%; height: 60px; resize: vertical; }
    input[list], input[type="text"] { width: 100%; }
  </style>
</head>
<body>
<!-- dalej bez zmian... -->
</body>
</html>
