<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Platforma Za≈Çadunku i Roz≈Çadunku</title>
  <style>
    body { font-family: Arial, sans-serif; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    .pilne { background-color: #ffe6e6; }
    .status-aktualne { background-color: #a5f3a1 !important; font-weight: bold; }
    .status-nieaktualne { background-color: #f9a1a1 !important; font-weight: bold; }
    .status-nieznane { background-color: #fff7a1 !important; font-weight: bold; }
    .date-time-group input {
      width: 45%;
      display: inline-block;
      margin: 2px 1%;
    }
    textarea { width: 100%; height: 60px; resize: vertical; }
    input[list], input[type="text"] { width: 100%; }
    #targeoMap {
      width: 100%;
      height: 500px;
      margin-top: 30px;
      border: none;
    }
  </style>
</head>
<body>

<div id="truck-ban-widget" style="position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; background: white; padding: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
  <button onclick="toggleTruckWidget()" style="margin-bottom: 5px;">Poka≈º/Ukryj zakazy ruchu</button>
  <div id="truck-widget-frame">
    <iframe src="https://trafficban.com/plugins/box.html?language=pl" width="100%" height="300" frameborder="0"></iframe>
  </div>
</div>
</div>

<div style="height: 340px;"></div>
<h1>Platforma Za≈Çadunku i Roz≈Çadunku</h1>
<button onclick="dodajWiersz()">‚ûï Dodaj nowy wiersz</button>
<datalist id="lokalizacje"></datalist>

<table id="tabela">
  <thead>
    <tr>
      <th>PILNE</th>
      <th>Za≈Çadunek</th>
      <th>Data za≈Çadunku (od-do)</th>
      <th>Godzina za≈Çadunku (od-do)</th>
      <th>Roz≈Çadunek</th>
      <th>Data roz≈Çadunku (od-do)</th>
      <th>Godzina roz≈Çadunku (od-do)</th>
      <th>Spos√≥b za≈Çadunku</th>
      <th>Potwierd≈∫ aktualno≈õƒá</th>
      <th>Uwagi</th>
      <th>Stawka</th>
      <th>Kilometry</th>
      <th>Stawka z km</th>
      <th>Mapka</th>
      <th>Akcje</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<div id="map" style="height: 500px; margin-top: 30px;"></div>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
window.addEventListener("DOMContentLoaded", async () => {
  await wczytajZSupabase();
  podlaczAutoZapis();
  zaladujMiasta();
});
// üîÅ Zapis automatyczny po ka≈ºdej zmianie w polach
function podlaczAutoZapis() {
  document.querySelectorAll('#tabela tbody tr').forEach(wiersz => {
    wiersz.querySelectorAll('input, select, textarea').forEach(el => {
      el.addEventListener('change', () => zapiszWierszDoSupabase(wiersz));
      el.addEventListener('input', () => zapiszWierszDoSupabase(wiersz));
    });
  });
});
}

// üîÑ Uruchom po za≈Çadowaniu danych z Supabase
window.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => podlaczAutoZapis(), 2000); // odczekaj a≈º dane siƒô za≈ÇadujƒÖ i dopiero pod≈ÇƒÖcz listener
});

// Supabase config
const SUPABASE_URL = "https://bfknyzfmhojjghhkxyrv.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJma255emZtaG9qamdoaGt4eXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyOTc4NTYsImV4cCI6MjA2Mzg3Mzg1Nn0.pQbR3wHdzhE4nP7PEIn5rASLNNwFa3-qKqkymDgxVLc";
const supabaseHeaders = {
  'Content-Type': 'application/json',
  'apikey': SUPABASE_KEY,
  'Authorization': `Bearer ${SUPABASE_KEY}`
};

async function zapiszWierszDoSupabase(wiersz) {
  const cells = wiersz.querySelectorAll("td");
  const rekord = {
    zaladunek: cells[1].querySelector("input")?.value,
    data_z: cells[2].querySelectorAll("input")[0]?.value,
    data_do: cells[2].querySelectorAll("input")[1]?.value,
    godzina_z: cells[3].querySelectorAll("input")[0]?.value,
    godzina_do: cells[3].querySelectorAll("input")[1]?.value,
    rozladunek: cells[4].querySelector("input")?.value,
    sposob: cells[7].querySelector("select")?.value,
    status: cells[8].querySelector("select")?.value,
    uwagi: cells[9].querySelector("textarea")?.value,
    stawka: parseFloat(cells[10].querySelector("input")?.value.replace(',', '.')),
    km: parseFloat(cells[11].querySelector("input")?.value.replace(',', '.')),
    stawka_z_km: parseFloat(cells[12].querySelector("input")?.value.replace(',', '.'))
  };

  const rekordId = wiersz.getAttribute("data-id");
  if (rekordId) {
    await fetch(`${SUPABASE_URL}/rest/v1/zaladunki?id=eq.${rekordId}`, {
      method: 'PATCH',
      headers: { ...supabaseHeaders, 'Prefer': 'return=representation' },
      body: JSON.stringify(rekord)
    });
  } else {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/zaladunki`, {
      method: 'POST',
      headers: { ...supabaseHeaders, 'Prefer': 'return=representation' },
      body: JSON.stringify(rekord)
    });
    const inserted = await res.json();
    console.log("üì¶ Supabase response (insert):", inserted);
    if (inserted && inserted[0] && inserted[0].id) {
      wiersz.setAttribute("data-id", inserted[0].id);
      console.log("‚úÖ Rekord zapisany z ID:", inserted[0].id);
    } else {
      console.warn("‚ö†Ô∏è Supabase NIE zwr√≥ci≈Ço ID!", inserted);
    }
  }
};

    const rekordId = wiersz.getAttribute("data-id");
    if (rekordId) {
      await fetch(`${SUPABASE_URL}/rest/v1/zaladunki?id=eq.${rekordId}`, {
        method: 'PATCH',
        headers: {
        ...supabaseHeaders,
        'Prefer': 'return=representation'
      },
        body: JSON.stringify(rekord)
      });
    } else {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/zaladunki`, {
        method: 'POST',
        headers: {
        ...supabaseHeaders,
        'Prefer': 'return=representation'
      },
        body: JSON.stringify(rekord)
      });
      const inserted = await res.json();
      console.log("üì¶ Supabase response (insert):", inserted);
      if (inserted && inserted[0] && inserted[0].id) {
        wiersz.setAttribute("data-id", inserted[0].id);
        console.log("‚úÖ Rekord zapisany z ID:", inserted[0].id);
      } else {
        console.warn("‚ö†Ô∏è Supabase NIE zwr√≥ci≈Ço ID!", inserted);
      }
    }
  }
}

async function wczytajZSupabase() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/zaladunki`, { headers: supabaseHeaders });
  const dane = await res.json();
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";
  dane.forEach(rekord => {
    dodajWiersz();
    const ostatni = document.querySelector("#tabela tbody tr:last-child");
    const cells = ostatni.querySelectorAll("td");
    ostatni.setAttribute("data-id", rekord.id);
    if (cells[1]) cells[1].querySelector("input").value = rekord.zaladunek || "";
    if (cells[2]) {
      cells[2].querySelectorAll("input")[0].value = rekord.data_z || "";
      cells[2].querySelectorAll("input")[1].value = rekord.data_do || "";
    }
    if (cells[3]) {
      cells[3].querySelectorAll("input")[0].value = rekord.godzina_z || "";
      cells[3].querySelectorAll("input")[1].value = rekord.godzina_do || "";
    }
    if (cells[4]) cells[4].querySelector("input").value = rekord.rozladunek || "";
    if (cells[7]) cells[7].querySelector("select").value = rekord.sposob || "";
    if (cells[8]) cells[8].querySelector("select").value = rekord.status || "";
    if (cells[9]) cells[9].querySelector("textarea").value = rekord.uwagi || "";
    if (cells[10]) cells[10].querySelector("input").value = rekord.stawka || "";
    if (cells[11]) cells[11].querySelector("input").value = rekord.km || "";
    if (cells[12]) cells[12].querySelector("input").value = rekord.stawka_z_km || "";
  });
}
    if (cells[3]) {
      cells[3].querySelectorAll("input")[0].value = rekord.godzina_z || "";
      cells[3].querySelectorAll("input")[1].value = rekord.godzina_do || "";
    }
    if (cells[4]) cells[4].querySelector("input").value = rekord.rozladunek || "";
    if (cells[7]) cells[7].querySelector("select").value = rekord.sposob || "";
    if (cells[8]) cells[8].querySelector("select").value = rekord.status || "";
    if (cells[9]) cells[9].querySelector("textarea").value = rekord.uwagi || "";
    if (cells[10]) cells[10].querySelector("input").value = rekord.stawka || "";
    if (cells[11]) cells[11].querySelector("input").value = rekord.km || "";
    if (cells[12]) cells[12].querySelector("input").value = rekord.stawka_z_km || "";
  });
}



function toggleTruckWidget() {
  const frame = document.getElementById("truck-widget-frame");
  const button = document.querySelector("#truck-ban-widget button");
  const isHidden = frame.style.display === "none";
  frame.style.display = isHidden ? "block" : "none";
  button.textContent = isHidden ? "Ukryj zakazy ruchu" : "Poka≈º zakazy ruchu";
}

function zaladujMiasta() {
  fetch('kodypolska.json')
    .then(response => {
      if (!response.ok) throw new Error('Brak dostƒôpu do pliku kodypolska.json');
      return response.json();
    })
    .then(data => {
      const datalist = document.getElementById("lokalizacje");
      if (!datalist) return;
      datalist.innerHTML = "";
      data.forEach(entry => {
        const option = document.createElement("option");
        option.value = `${entry.place_name} ${entry.postal_code}`;
        datalist.appendChild(option);
      });
      console.log("Za≈Çadowano miasta:", data.length);
    })
    .catch(error => console.error("B≈ÇƒÖd ≈Çadowania miejscowo≈õci:", error));
}
}


    
</script>

<script>
function dodajWiersz() {
  const tabela = document.querySelector("#tabela tbody");
  if (!tabela) return;
  const wiersz = tabela.insertRow();
  wiersz.classList.add("pilne");
  wiersz.innerHTML = `
    <td><input type="checkbox" checked onclick="togglePilne(this)"></td>
    <td><input type="text" list="lokalizacje" placeholder="Miasto Kod"></td>
    <td class="date-time-group"><input type="date"> <input type="date"></td>
    <td class="date-time-group"><input type="time"> <input type="time"></td>
    <td><input type="text" list="lokalizacje" placeholder="Miasto Kod"></td>
    <td class="date-time-group"><input type="date"> <input type="date"></td>
    <td class="date-time-group"><input type="time"> <input type="time"></td>
    <td>
      <select>
        <option value="ty≈Çem">Ty≈Çem</option>
        <option value="bokiem">Bokiem</option>
        <option value="g√≥rƒÖ">G√≥rƒÖ</option>
        <option value="bok_g√≥ra">Bok + G√≥ra</option>
        <option value="auto_winda">Auto z windƒÖ</option>
        <option value="inne">Inne</option>
      </select>
    </td>
    <td>
      <select onchange="zmienAktualnosc(this)">
        <option value="">-- wybierz --</option>
        <option value="aktualne">Aktualne</option>
        <option value="nieaktualne">Nieaktualne</option>
        <option value="nieznane">???</option>
      </select>
    </td>
    <td><textarea placeholder="Uwagi"></textarea></td>
    <td><input type="text" placeholder="Stawka"></td>
    <td><input type="text" placeholder="km"></td>
    <td><input type="text" placeholder="z≈Ç/km"></td>
    <td><input type="checkbox" onchange="pokazNaMapie(this)"></td>
    <td><button onclick="usunWiersz(this)">üóëÔ∏è Usu≈Ñ</button></td>
  `;
  podlaczAutoZapis();
  zapiszWierszDoSupabase(wiersz);
}

function usunWiersz(button) {
  if (confirm("Czy na pewno chcesz usunƒÖƒá ten wiersz?")) {
    const wiersz = button.closest("tr");
    wiersz.remove();
  }
}
</script>
<script>
function aktualizujStawkeZKm(wiersz) {
  const kmInput = wiersz.cells[11].querySelector("input");
  const stawkaInput = wiersz.cells[10].querySelector("input");
  const wynikInput = wiersz.cells[12].querySelector("input");
  const km = parseFloat(kmInput.value.replace(',', '.'));
  const stawka = parseFloat(stawkaInput.value.replace(',', '.'));
  if (!isNaN(km) && !isNaN(stawka) && km > 0) {
    wynikInput.value = (stawka / km).toFixed(2);
  } else {
    wynikInput.value = "";
  }
}

// Obserwuj zmiany warto≈õci w stawce i kilometrach
setInterval(() => {
  document.querySelectorAll("#tabela tbody tr").forEach(wiersz => {
    aktualizujStawkeZKm(wiersz);
  });
}, 1000);
</script>

<script>
function pokazNaMapie(checkbox) {
  if (!checkbox.checked) return;

  const wiersz = checkbox.closest("tr");
  const ladunek = wiersz.cells[1].querySelector("input").value;
  const rozladunek = wiersz.cells[4].querySelector("input").value;
  const kmCell = wiersz.cells[11].querySelector("input");
  const stawkaCell = wiersz.cells[10].querySelector("input");
  const stawkaKmCell = wiersz.cells[12].querySelector("input");

  Promise.all([
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ladunek)}`)
      .then(res => res.json())
      .then(data => data[0] && [parseFloat(data[0].lon), parseFloat(data[0].lat)]),
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(rozladunek)}`)
      .then(res => res.json())
      .then(data => data[0] && [parseFloat(data[0].lon), parseFloat(data[0].lat)])
  ]).then(([startCoord, endCoord]) => {
    if (!startCoord || !endCoord) return;

    const url = `https://router.project-osrm.org/route/v1/driving/${startCoord.join(',')};${endCoord.join(',')}?overview=full&geometries=geojson`;
    fetch(url)
      .then(res => res.json())
      .then(result => {
        if (!result.routes || !result.routes[0]) return;

        const route = result.routes[0];
        const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);

        if (window.mapLayer) { map.removeLayer(window.mapLayer); window.mapLayer = null; }
if (window.startMarker) { map.removeLayer(window.startMarker); window.startMarker = null; }
if (window.endMarker) { map.removeLayer(window.endMarker); window.endMarker = null; }

        window.mapLayer = L.polyline(coords, { color: 'blue' }).addTo(map);
        window.startMarker = L.marker([startCoord[1], startCoord[0]]).addTo(map).bindPopup('Za≈Çadunek');
        window.endMarker = L.marker([endCoord[1], endCoord[0]]).addTo(map).bindPopup('Roz≈Çadunek');
        map.fitBounds(window.mapLayer.getBounds());

        const km = (route.distance / 1000).toFixed(1);
        if (kmCell) kmCell.value = km;
        const stawka = parseFloat(stawkaCell.value.replace(',', '.'));
        if (!isNaN(stawka) && km > 0 && stawkaKmCell) {
          stawkaKmCell.value = (stawka / km).toFixed(2);
        }
      });
  });
}
</script>
<script>
const map = L.map('map').setView([52.2297, 21.0122], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap',
  maxZoom: 18
}).addTo(map);
</script>
</body>
</html>
