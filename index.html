
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Platforma Załadunkowa</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const client = window.supabase.createClient(
      'https://bfknyzfmhojjghhkxyrv.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJma255emZtaG9qamdoaGt4eXJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyOTc4NTYsImV4cCI6MjA2Mzg3Mzg1Nn0.pQbR3wHdzhE4nP7PEIn5rASLNNwFa3-qKqkymDgxVLc'
    );
  </script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    th, td { padding: 8px; text-align: center; }
    table { width: 100%; margin-bottom: 20px; }
    button { margin-right: 10px; }
  </style>
</head>
<body>

<h1>Platforma Załadunku i Rozładunku</h1>
<p style="color: green; font-weight: bold;">✅ Wszystkie dane zapisywane są automatycznie po ich wpisaniu – nie musisz klikać przycisku "Zapisz".</p>

<div id="truck-ban-widget" style="margin: 10px 0; text-align: center;">
  <button onclick="toggleTruckWidget()" style="margin-bottom: 5px;">Pokaż/Ukryj zakazy ruchu</button>
  <div id="truck-widget-frame">
    <iframe id="truck-iframe" src="https://trafficban.com/plugins/box.html?language=pl" width="100%" height="160" frameborder="0" style="border:none; overflow:hidden;"></iframe>
  </div>
</div>

<table id="tabela">
  <thead>
    <tr><th>Załadunek</th><th>Rozładunek</th><th>Uwagi</th></tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="dodajWiersz()">➕ Dodaj nowy wiersz</button>

<script>
  function toggleTruckWidget() {
    const frame = document.getElementById("truck-widget-frame");
    frame.style.display = (frame.style.display === "none") ? "block" : "none";
  }

  function dodajWiersz() {
    const tbody = document.querySelector("#tabela tbody");
    const row = tbody.insertRow();
    row.dataset.zapisany = "false";
    row.innerHTML = \`
      <td><input type="text" placeholder="Załadunek"></td>
      <td><input type="text" placeholder="Rozładunek"></td>
      <td><input type="text" placeholder="Uwagi"></td>
    \`;
  }

  async function zapiszWierszAutomatycznie(row) {
    if (row.dataset.zapisany === "true") return;

    const dane = {
      zaladunek: row.cells[0].querySelector("input").value,
      rozladunek: row.cells[1].querySelector("input").value,
      uwagi: row.cells[2].querySelector("input").value,
    };

    const { data, error } = await client.from("translider").insert([dane]).select("id");
    if (error) {
      console.error("❌ Błąd auto zapisu:", error.message);
    } else {
      row.dataset.zapisany = "true";
      row.dataset.id = data[0]?.id;
      console.log("✅ Autozapisano nowy wiersz do Supabase");
    }
  }

  document.addEventListener("change", (e) => {
    const row = e.target.closest("tr");
    if (row && row.dataset.zapisany === "false") zapiszWierszAutomatycznie(row);
  });

  document.addEventListener("blur", (e) => {
    const row = e.target.closest("tr");
    if (row && row.dataset.zapisany === "false") zapiszWierszAutomatycznie(row);
  }, true);

  window.addEventListener("DOMContentLoaded", async () => {
    const { data, error } = await client.from("translider").select("*");
    if (error) {
      console.error("❌ Błąd odczytu danych:", error.message);
      return;
    }
    const tbody = document.querySelector("#tabela tbody");
    data.forEach(entry => {
      const row = tbody.insertRow();
      row.dataset.zapisany = "true";
      row.dataset.id = entry.id;
      row.innerHTML = \`
        <td><input type="text" value="\${entry.zaladunek || ''}"></td>
        <td><input type="text" value="\${entry.rozladunek || ''}"></td>
        <td><input type="text" value="\${entry.uwagi || ''}"></td>
      \`;
    });
  });

  document.addEventListener("DOMContentLoaded", () => {
    const iframe = document.getElementById("truck-iframe");
    iframe.onload = () => {
      try {
        const doc = iframe.contentWindow || iframe.contentDocument;
        setTimeout(() => {
          doc.scrollTo?.(0, 100);
        }, 100);
      } catch (e) {
        console.warn("Nie można przewinąć iframe (CORS)");
      }
    };
  });
</script>

</body>
</html>
